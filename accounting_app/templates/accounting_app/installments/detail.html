{% extends 'accounting_app/base.html' %}
{% load static %}

{% block title %}تفاصيل القسط: {{ installment.id }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">تفاصيل القسط</h1>
            <p class="text-muted">قسط الوحدة {{ installment.unit.code }}</p>
        </div>
        <div>
            <a href="{% url 'accounting_app:installment_list' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-right"></i> العودة للأقساط
            </a>
        </div>
    </div>

    <!-- Installment Info Card -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">بيانات القسط</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label fw-bold">الوحدة:</label>
                        <p class="mb-0">
                            <a href="{% url 'accounting_app:details:unit_detail' installment.unit.pk %}" 
                               class="text-decoration-none">
                                {{ installment.unit.code }} - {{ installment.unit.name|default:"بدون اسم" }}
                            </a>
                        </p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label fw-bold">المبلغ:</label>
                        <p class="mb-0 h4 text-primary">{{ installment.amount|floatformat:2 }} ريال</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label fw-bold">تاريخ الاستحقاق:</label>
                        <p class="mb-0">{{ installment.due_date|date:"Y-m-d" }}</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label fw-bold">الحالة:</label>
                        <span class="badge {% if installment.status == 'مدفوع' %}bg-success{% else %}bg-warning{% endif %} fs-6">
                            {{ installment.status }}
                        </span>
                    </div>
                </div>
                <div class="col-12">
                    <div class="mb-3">
                        <label class="form-label fw-bold">الملاحظات:</label>
                        <p class="mb-0">{{ installment.notes|default:"-" }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card {% if is_overdue %}bg-danger text-white{% else %}bg-success text-white{% endif %}">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">حالة الاستحقاق</h6>
                            <h3 class="mb-0">
                                {% if is_overdue %}
                                    متأخر
                                {% else %}
                                    في الموعد
                                {% endif %}
                            </h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas {% if is_overdue %}fa-exclamation-triangle{% else %}fa-check-circle{% endif %} fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">أيام التأخير</h6>
                            <h3 class="mb-0">{{ days_overdue }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-calendar-alt fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">نوع القسط</h6>
                            <h3 class="mb-0">
                                {% if installment.installment_type == 'regular' %}
                                    عادي
                                {% elif installment.installment_type == 'annual' %}
                                    سنوي
                                {% elif installment.installment_type == 'maintenance' %}
                                    صيانة
                                {% else %}
                                    {{ installment.installment_type }}
                                {% endif %}
                            </h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-tag fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contract Information -->
    {% if contract %}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">معلومات العقد</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label fw-bold">العميل:</label>
                        <p class="mb-0">
                            <a href="{% url 'accounting_app:details:customer_detail' contract.customer.pk %}" 
                               class="text-decoration-none">
                                {{ contract.customer.name }}
                            </a>
                        </p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label fw-bold">تاريخ العقد:</label>
                        <p class="mb-0">{{ contract.start|date:"Y-m-d" }}</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label fw-bold">السعر الإجمالي:</label>
                        <p class="mb-0">{{ contract.total_price|floatformat:2 }} ريال</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label fw-bold">نوع الدفع:</label>
                        <span class="badge {% if contract.payment_type == 'نقدي' %}bg-success{% else %}bg-warning{% endif %}">
                            {{ contract.payment_type }}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Installment History -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">تاريخ أقساط الوحدة</h5>
        </div>
        <div class="card-body">
            {% if installment_history %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>رقم القسط</th>
                                <th>المبلغ</th>
                                <th>تاريخ الاستحقاق</th>
                                <th>الحالة</th>
                                <th>النوع</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for hist_installment in installment_history %}
                            <tr class="{% if hist_installment.pk == installment.pk %}table-primary{% endif %}">
                                <td>{{ forloop.counter }}</td>
                                <td>{{ hist_installment.amount|floatformat:2 }} ريال</td>
                                <td>{{ hist_installment.due_date|date:"Y-m-d" }}</td>
                                <td>
                                    <span class="badge {% if hist_installment.status == 'مدفوع' %}bg-success{% else %}bg-warning{% endif %}">
                                        {{ hist_installment.status }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">
                                        {% if hist_installment.installment_type == 'regular' %}
                                            عادي
                                        {% elif hist_installment.installment_type == 'annual' %}
                                            سنوي
                                        {% elif hist_installment.installment_type == 'maintenance' %}
                                            صيانة
                                        {% else %}
                                            {{ hist_installment.installment_type }}
                                        {% endif %}
                                    </span>
                                </td>
                                <td>
                                    {% if hist_installment.pk == installment.pk %}
                                        <span class="badge bg-primary">الحالي</span>
                                    {% else %}
                                        <a href="{% url 'accounting_app:details:installment_detail' hist_installment.pk %}" 
                                           class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye"></i> عرض
                                        </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-calendar-alt fa-3x text-muted mb-3"></i>
                    <p class="text-muted">لا توجد أقساط أخرى لهذه الوحدة</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Actions -->
    <div class="card mt-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="card-title mb-0">إجراءات القسط</h6>
                    <p class="text-muted mb-0">يمكنك تعديل حالة القسط أو إضافة ملاحظات</p>
                </div>
                <div>
                    <a href="{% url 'accounting_app:installment_update' installment.pk %}" 
                       class="btn btn-primary">
                        <i class="fas fa-edit"></i> تعديل القسط
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}