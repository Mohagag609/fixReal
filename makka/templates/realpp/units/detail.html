{% extends 'base.html' %}

{% block title %}تفاصيل الوحدة - {{ unit.unit_number }} - مكة العقارية{% endblock %}
{% block page_title %}تفاصيل الوحدة{% endblock %}
{% block page_subtitle %}{{ unit.unit_number }}{% endblock %}

{% block content %}
<div class="space-y-6">
    
    <!-- Unit Header -->
    <div class="bg-white rounded-2xl shadow-lg p-8">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-4 lg:space-y-0">
            <div class="flex items-center space-x-6 space-x-reverse">
                <div class="w-20 h-20 bg-gradient-to-r from-purple-500 to-blue-600 rounded-2xl flex items-center justify-center">
                    <i class="fas fa-home text-white text-3xl"></i>
                </div>
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">{{ unit.unit_number }}</h1>
                    <p class="text-lg text-gray-600">{{ unit.get_unit_type_display }}</p>
                    <p class="text-sm text-gray-500">الطابق {{ unit.floor }} - المبنى {{ unit.building }}</p>
                </div>
            </div>
            
            <div class="flex items-center space-x-3 space-x-reverse">
                <a href="{% url 'realpp:units_edit' unit.id %}" 
                   class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-medium transition-colors flex items-center space-x-2 space-x-reverse">
                    <i class="fas fa-edit"></i>
                    <span>تعديل</span>
                </a>
                <button onclick="deleteUnit({{ unit.id }})" 
                        class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-xl font-medium transition-colors flex items-center space-x-2 space-x-reverse">
                    <i class="fas fa-trash"></i>
                    <span>حذف</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Unit Information -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        
        <!-- Basic Information -->
        <div class="bg-white rounded-2xl shadow-lg p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
                <i class="fas fa-info-circle text-blue-600 ml-3"></i>
                المعلومات الأساسية
            </h2>
            
            <div class="space-y-4">
                <div class="flex justify-between items-center py-3 border-b border-gray-100">
                    <span class="text-gray-600">رقم الوحدة</span>
                    <span class="font-medium text-gray-900">{{ unit.unit_number }}</span>
                </div>
                
                <div class="flex justify-between items-center py-3 border-b border-gray-100">
                    <span class="text-gray-600">نوع الوحدة</span>
                    <span class="font-medium text-gray-900">{{ unit.get_unit_type_display }}</span>
                </div>
                
                <div class="flex justify-between items-center py-3 border-b border-gray-100">
                    <span class="text-gray-600">الطابق</span>
                    <span class="font-medium text-gray-900">{{ unit.floor }}</span>
                </div>
                
                <div class="flex justify-between items-center py-3 border-b border-gray-100">
                    <span class="text-gray-600">المبنى</span>
                    <span class="font-medium text-gray-900">{{ unit.building }}</span>
                </div>
                
                <div class="flex justify-between items-center py-3 border-b border-gray-100">
                    <span class="text-gray-600">الحالة</span>
                    <span class="px-3 py-1 text-xs font-medium rounded-full 
                        {% if unit.status == 'available' %}bg-green-100 text-green-800
                        {% elif unit.status == 'sold' %}bg-red-100 text-red-800
                        {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                        {{ unit.get_status_display }}
                    </span>
                </div>
                
                <div class="flex justify-between items-center py-3">
                    <span class="text-gray-600">تاريخ الإنشاء</span>
                    <span class="font-medium text-gray-900">{{ unit.created_at|date:"Y-m-d" }}</span>
                </div>
            </div>
        </div>
        
        <!-- Specifications -->
        <div class="bg-white rounded-2xl shadow-lg p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
                <i class="fas fa-ruler-combined text-green-600 ml-3"></i>
                المواصفات
            </h2>
            
            <div class="space-y-4">
                <div class="flex justify-between items-center py-3 border-b border-gray-100">
                    <span class="text-gray-600">المساحة</span>
                    <span class="font-medium text-gray-900">{{ unit.area }} م²</span>
                </div>
                
                <div class="flex justify-between items-center py-3 border-b border-gray-100">
                    <span class="text-gray-600">عدد الغرف</span>
                    <span class="font-medium text-gray-900">{{ unit.rooms|default:"غير محدد" }}</span>
                </div>
                
                <div class="flex justify-between items-center py-3 border-b border-gray-100">
                    <span class="text-gray-600">عدد دورات المياه</span>
                    <span class="font-medium text-gray-900">{{ unit.bathrooms|default:"غير محدد" }}</span>
                </div>
                
                <div class="flex justify-between items-center py-3 border-b border-gray-100">
                    <span class="text-gray-600">السعر</span>
                    <span class="font-bold text-blue-600">{{ unit.price|floatformat:0 }} ريال</span>
                </div>
                
                <div class="flex justify-between items-center py-3 border-b border-gray-100">
                    <span class="text-gray-600">الخصم</span>
                    <span class="font-medium text-gray-900">{{ unit.discount|floatformat:0 }} ريال</span>
                </div>
                
                <div class="flex justify-between items-center py-3">
                    <span class="text-gray-600">السعر النهائي</span>
                    <span class="font-bold text-green-600">{{ unit.final_price|floatformat:0 }} ريال</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Unit Features -->
    <div class="bg-white rounded-2xl shadow-lg p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
            <i class="fas fa-star text-yellow-600 ml-3"></i>
            مميزات الوحدة
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="flex items-center space-x-3 space-x-reverse p-4 rounded-xl {% if unit.has_balcony %}bg-green-50 border border-green-200{% else %}bg-gray-50 border border-gray-200{% endif %}">
                <i class="fas fa-home text-2xl {% if unit.has_balcony %}text-green-600{% else %}text-gray-400{% endif %}"></i>
                <div>
                    <div class="font-medium text-gray-900">شرفة</div>
                    <div class="text-sm text-gray-600">{% if unit.has_balcony %}متوفر{% else %}غير متوفر{% endif %}</div>
                </div>
            </div>
            
            <div class="flex items-center space-x-3 space-x-reverse p-4 rounded-xl {% if unit.has_parking %}bg-green-50 border border-green-200{% else %}bg-gray-50 border border-gray-200{% endif %}">
                <i class="fas fa-car text-2xl {% if unit.has_parking %}text-green-600{% else %}text-gray-400{% endif %}"></i>
                <div>
                    <div class="font-medium text-gray-900">موقف سيارات</div>
                    <div class="text-sm text-gray-600">{% if unit.has_parking %}متوفر{% else %}غير متوفر{% endif %}</div>
                </div>
            </div>
            
            <div class="flex items-center space-x-3 space-x-reverse p-4 rounded-xl {% if unit.has_elevator %}bg-green-50 border border-green-200{% else %}bg-gray-50 border border-gray-200{% endif %}">
                <i class="fas fa-elevator text-2xl {% if unit.has_elevator %}text-green-600{% else %}text-gray-400{% endif %}"></i>
                <div>
                    <div class="font-medium text-gray-900">مصعد</div>
                    <div class="text-sm text-gray-600">{% if unit.has_elevator %}متوفر{% else %}غير متوفر{% endif %}</div>
                </div>
            </div>
            
            <div class="flex items-center space-x-3 space-x-reverse p-4 rounded-xl {% if unit.has_garden %}bg-green-50 border border-green-200{% else %}bg-gray-50 border border-gray-200{% endif %}">
                <i class="fas fa-seedling text-2xl {% if unit.has_garden %}text-green-600{% else %}text-gray-400{% endif %}"></i>
                <div>
                    <div class="font-medium text-gray-900">حديقة</div>
                    <div class="text-sm text-gray-600">{% if unit.has_garden %}متوفر{% else %}غير متوفر{% endif %}</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Unit Description -->
    {% if unit.description or unit.notes %}
    <div class="bg-white rounded-2xl shadow-lg p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
            <i class="fas fa-align-right text-purple-600 ml-3"></i>
            الوصف والملاحظات
        </h2>
        
        <div class="space-y-4">
            {% if unit.description %}
            <div>
                <h3 class="text-lg font-medium text-gray-800 mb-2">الوصف التفصيلي</h3>
                <p class="text-gray-700 leading-relaxed">{{ unit.description }}</p>
            </div>
            {% endif %}
            
            {% if unit.notes %}
            <div>
                <h3 class="text-lg font-medium text-gray-800 mb-2">ملاحظات إضافية</h3>
                <p class="text-gray-700 leading-relaxed">{{ unit.notes }}</p>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
    
    <!-- Unit Partners -->
    {% if unit.unitpartners.all %}
    <div class="bg-white rounded-2xl shadow-lg p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
            <i class="fas fa-users text-orange-600 ml-3"></i>
            شركاء الوحدة
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for partner in unit.unitpartners.all %}
            <div class="p-4 bg-orange-50 rounded-xl border border-orange-200">
                <div class="flex items-center space-x-3 space-x-reverse mb-3">
                    <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-user text-orange-600"></i>
                    </div>
                    <div>
                        <h3 class="font-medium text-gray-900">{{ partner.partner.name }}</h3>
                        <p class="text-sm text-gray-600">{{ partner.partner.phone }}</p>
                    </div>
                </div>
                <div class="text-sm text-gray-700">
                    <div class="flex justify-between">
                        <span>نسبة الملكية:</span>
                        <span class="font-medium">{{ partner.ownership_percentage }}%</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- Unit Contracts -->
    {% if unit.contracts.all %}
    <div class="bg-white rounded-2xl shadow-lg p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
            <i class="fas fa-file-contract text-red-600 ml-3"></i>
            عقود الوحدة
        </h2>
        
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-right text-sm font-medium text-gray-700">رقم العقد</th>
                        <th class="px-6 py-3 text-right text-sm font-medium text-gray-700">العميل</th>
                        <th class="px-6 py-3 text-right text-sm font-medium text-gray-700">إجمالي السعر</th>
                        <th class="px-6 py-3 text-right text-sm font-medium text-gray-700">تاريخ العقد</th>
                        <th class="px-6 py-3 text-right text-sm font-medium text-gray-700">الحالة</th>
                        <th class="px-6 py-3 text-right text-sm font-medium text-gray-700">الإجراءات</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for contract in unit.contracts.all %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 font-medium text-gray-900">{{ contract.contract_number }}</td>
                        <td class="px-6 py-4 text-gray-900">{{ contract.customer.name }}</td>
                        <td class="px-6 py-4 text-gray-900">{{ contract.total_price|floatformat:0 }} ريال</td>
                        <td class="px-6 py-4 text-gray-900">{{ contract.created_at|date:"Y-m-d" }}</td>
                        <td class="px-6 py-4">
                            <span class="px-3 py-1 text-xs font-medium rounded-full 
                                {% if contract.status == 'active' %}bg-green-100 text-green-800
                                {% elif contract.status == 'completed' %}bg-blue-100 text-blue-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ contract.get_status_display }}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <a href="{% url 'realpp:contracts_detail' contract.id %}" 
                               class="text-blue-600 hover:text-blue-800 font-medium">عرض</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
    
</div>

<script>
function deleteUnit(unitId) {
    if (confirm('هل أنت متأكد من حذف هذه الوحدة؟ سيتم حذف جميع البيانات المرتبطة بها.')) {
        fetch(`/units/${unitId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = '{% url "realpp:units_list" %}';
            } else {
                alert('حدث خطأ أثناء حذف الوحدة: ' + (data.error || 'خطأ غير معروف'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('حدث خطأ أثناء حذف الوحدة');
        });
    }
}
</script>
{% endblock %}