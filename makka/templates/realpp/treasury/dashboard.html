{% extends 'base.html' %}

{% block title %}الخزينة - مكة العقارية{% endblock %}
{% block page_title %}إدارة الخزينة{% endblock %}
{% block page_subtitle %}عرض وإدارة الخزائن والتحويلات المالية{% endblock %}

{% block content %}
<div class="space-y-6">
    
    <!-- Treasury Summary -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-2xl p-6 text-white shadow-lg">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-green-100 text-sm font-medium">إجمالي الأموال</p>
                    <p class="text-3xl font-bold">{{ total_funds|floatformat:0 }} ريال</p>
                </div>
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                    <i class="fas fa-coins text-2xl"></i>
                </div>
            </div>
        </div>
        
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-2xl p-6 text-white shadow-lg">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-blue-100 text-sm font-medium">عدد الخزائن</p>
                    <p class="text-3xl font-bold">{{ total_safes }}</p>
                </div>
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                    <i class="fas fa-vault text-2xl"></i>
                </div>
            </div>
        </div>
        
        <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-2xl p-6 text-white shadow-lg">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-purple-100 text-sm font-medium">التحويلات اليوم</p>
                    <p class="text-3xl font-bold">{{ today_transfers }}</p>
                </div>
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                    <i class="fas fa-exchange-alt text-2xl"></i>
                </div>
            </div>
        </div>
        
        <div class="bg-gradient-to-r from-orange-500 to-orange-600 rounded-2xl p-6 text-white shadow-lg">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-orange-100 text-sm font-medium">إجمالي التحويلات</p>
                    <p class="text-3xl font-bold">{{ total_transfers|floatformat:0 }} ريال</p>
                </div>
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                    <i class="fas fa-chart-line text-2xl"></i>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="bg-white rounded-2xl shadow-lg p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-6">الإجراءات السريعة</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <button onclick="openAddSafeModal()" 
                    class="group p-6 bg-gradient-to-r from-green-50 to-green-100 rounded-xl hover:from-green-100 hover:to-green-200 transition-all duration-300 border border-green-200 hover:border-green-300">
                <div class="flex items-center space-x-3 space-x-reverse mb-3">
                    <div class="w-10 h-10 bg-green-500 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                        <i class="fas fa-plus text-white"></i>
                    </div>
                    <h3 class="font-semibold text-gray-900">إضافة خزينة</h3>
                </div>
                <p class="text-sm text-gray-600">إضافة خزينة جديدة</p>
            </button>
            
            <button onclick="openTransferModal()" 
                    class="group p-6 bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl hover:from-blue-100 hover:to-blue-200 transition-all duration-300 border border-blue-200 hover:border-blue-300">
                <div class="flex items-center space-x-3 space-x-reverse mb-3">
                    <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                        <i class="fas fa-exchange-alt text-white"></i>
                    </div>
                    <h3 class="font-semibold text-gray-900">تحويل أموال</h3>
                </div>
                <p class="text-sm text-gray-600">تحويل أموال بين الخزائن</p>
            </button>
            
            <button onclick="openDepositModal()" 
                    class="group p-6 bg-gradient-to-r from-purple-50 to-purple-100 rounded-xl hover:from-purple-100 hover:to-purple-200 transition-all duration-300 border border-purple-200 hover:border-purple-300">
                <div class="flex items-center space-x-3 space-x-reverse mb-3">
                    <div class="w-10 h-10 bg-purple-500 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                        <i class="fas fa-arrow-down text-white"></i>
                    </div>
                    <h3 class="font-semibold text-gray-900">إيداع</h3>
                </div>
                <p class="text-sm text-gray-600">إيداع أموال في خزينة</p>
            </button>
            
            <button onclick="openWithdrawModal()" 
                    class="group p-6 bg-gradient-to-r from-orange-50 to-orange-100 rounded-xl hover:from-orange-100 hover:to-orange-200 transition-all duration-300 border border-orange-200 hover:border-orange-300">
                <div class="flex items-center space-x-3 space-x-reverse mb-3">
                    <div class="w-10 h-10 bg-orange-500 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                        <i class="fas fa-arrow-up text-white"></i>
                    </div>
                    <h3 class="font-semibold text-gray-900">سحب</h3>
                </div>
                <p class="text-sm text-gray-600">سحب أموال من خزينة</p>
            </button>
        </div>
    </div>
    
    <!-- Safes Overview -->
    <div class="bg-white rounded-2xl shadow-lg p-6">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-semibold text-gray-900">الخزائن</h2>
            <a href="{% url 'realpp:safes_list' %}" class="text-blue-600 hover:text-blue-700 text-sm font-medium">عرض الكل</a>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for safe in safes %}
            <div class="p-6 bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl border border-gray-200 hover:shadow-md transition-shadow">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-3 space-x-reverse">
                        <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-vault text-blue-600 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">{{ safe.name }}</h3>
                            <p class="text-sm text-gray-600">{{ safe.description|default:"لا يوجد وصف" }}</p>
                        </div>
                    </div>
                    <span class="px-3 py-1 text-xs font-medium rounded-full 
                        {% if safe.is_active %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                        {% if safe.is_active %}نشط{% else %}غير نشط{% endif %}
                    </span>
                </div>
                
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">الرصيد الحالي</span>
                        <span class="font-bold text-lg text-gray-900">{{ safe.current_balance|floatformat:0 }} ريال</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">الحد الأقصى</span>
                        <span class="text-gray-900">{{ safe.max_balance|floatformat:0 }} ريال</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">نسبة الامتلاء</span>
                        <span class="text-gray-900">{{ safe.occupancy_percentage }}%</span>
                    </div>
                </div>
                
                <div class="mt-4 w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-blue-600 h-2 rounded-full" style="width: {{ safe.occupancy_percentage }}%"></div>
                </div>
                
                <div class="mt-4 flex items-center justify-between">
                    <a href="{% url 'realpp:safes_detail' safe.id %}" 
                       class="text-blue-600 hover:text-blue-800 font-medium text-sm">عرض التفاصيل</a>
                    <div class="flex items-center space-x-2 space-x-reverse">
                        <button onclick="editSafe({{ safe.id }})" 
                                class="p-2 text-green-600 hover:bg-green-50 rounded-lg transition-colors">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteSafe({{ safe.id }})" 
                                class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-span-full text-center py-12 text-gray-500">
                <i class="fas fa-vault text-6xl mb-4"></i>
                <p class="text-xl">لا توجد خزائن</p>
                <p class="text-sm">ابدأ بإضافة خزينة جديدة</p>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Recent Transfers -->
    <div class="bg-white rounded-2xl shadow-lg p-6">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-semibold text-gray-900">التحويلات الأخيرة</h2>
            <a href="{% url 'realpp:transfers_list' %}" class="text-blue-600 hover:text-blue-700 text-sm font-medium">عرض الكل</a>
        </div>
        
        <div class="space-y-4">
            {% for transfer in recent_transfers %}
            <div class="flex items-center space-x-4 space-x-reverse p-4 bg-gray-50 rounded-xl">
                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-exchange-alt text-blue-600"></i>
                </div>
                <div class="flex-1">
                    <h3 class="font-medium text-gray-900">تحويل من {{ transfer.from_safe.name }} إلى {{ transfer.to_safe.name }}</h3>
                    <p class="text-sm text-gray-600">المبلغ: {{ transfer.amount|floatformat:0 }} ريال</p>
                </div>
                <div class="text-left">
                    <p class="text-sm text-gray-500">{{ transfer.created_at|date:"Y-m-d H:i" }}</p>
                    <span class="px-2 py-1 text-xs font-medium rounded-full 
                        {% if transfer.status == 'completed' %}bg-green-100 text-green-800
                        {% elif transfer.status == 'pending' %}bg-yellow-100 text-yellow-800
                        {% else %}bg-red-100 text-red-800{% endif %}">
                        {{ transfer.get_status_display }}
                    </span>
                </div>
            </div>
            {% empty %}
            <div class="text-center py-8 text-gray-500">
                <i class="fas fa-exchange-alt text-4xl mb-4"></i>
                <p>لا توجد تحويلات حديثة</p>
            </div>
            {% endfor %}
        </div>
    </div>
    
</div>

<!-- Add Safe Modal -->
<div id="addSafeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-gray-900">إضافة خزينة جديدة</h3>
                <button onclick="closeAddSafeModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form method="post" action="{% url 'realpp:safes_create' %}">
                {% csrf_token %}
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">اسم الخزينة</label>
                        <input type="text" name="name" required 
                               class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">الوصف</label>
                        <textarea name="description" 
                                  class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">الحد الأقصى (ريال)</label>
                        <input type="number" name="max_balance" required 
                               class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>
                
                <div class="flex items-center justify-end space-x-3 space-x-reverse mt-6">
                    <button type="button" onclick="closeAddSafeModal()" 
                            class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium">
                        إلغاء
                    </button>
                    <button type="submit" 
                            class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-medium transition-colors">
                        إضافة
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Transfer Modal -->
<div id="transferModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-gray-900">تحويل أموال</h3>
                <button onclick="closeTransferModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form method="post" action="{% url 'realpp:transfers_create' %}">
                {% csrf_token %}
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">من الخزينة</label>
                        <select name="from_safe" required 
                                class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">اختر الخزينة المصدر</option>
                            {% for safe in safes %}
                            <option value="{{ safe.id }}">{{ safe.name }} ({{ safe.current_balance|floatformat:0 }} ريال)</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">إلى الخزينة</label>
                        <select name="to_safe" required 
                                class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">اختر الخزينة الهدف</option>
                            {% for safe in safes %}
                            <option value="{{ safe.id }}">{{ safe.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">المبلغ (ريال)</label>
                        <input type="number" name="amount" required 
                               class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">الملاحظات</label>
                        <textarea name="notes" 
                                  class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                    </div>
                </div>
                
                <div class="flex items-center justify-end space-x-3 space-x-reverse mt-6">
                    <button type="button" onclick="closeTransferModal()" 
                            class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium">
                        إلغاء
                    </button>
                    <button type="submit" 
                            class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-medium transition-colors">
                        تحويل
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function openAddSafeModal() {
    document.getElementById('addSafeModal').classList.remove('hidden');
}

function closeAddSafeModal() {
    document.getElementById('addSafeModal').classList.add('hidden');
}

function openTransferModal() {
    document.getElementById('transferModal').classList.remove('hidden');
}

function closeTransferModal() {
    document.getElementById('transferModal').classList.add('hidden');
}

function openDepositModal() {
    // Implement deposit modal
    alert('سيتم تنفيذ نافذة الإيداع قريباً');
}

function openWithdrawModal() {
    // Implement withdraw modal
    alert('سيتم تنفيذ نافذة السحب قريباً');
}

function editSafe(safeId) {
    window.location.href = `/safes/${safeId}/edit/`;
}

function deleteSafe(safeId) {
    if (confirm('هل أنت متأكد من حذف هذه الخزينة؟')) {
        fetch(`/safes/${safeId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('حدث خطأ أثناء حذف الخزينة: ' + (data.error || 'خطأ غير معروف'));
            }
        });
    }
}
</script>
{% endblock %}